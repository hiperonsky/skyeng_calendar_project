О проекте
=========

**Skyeng Calendar Project** автоматически экспортирует расписание занятий из личного кабинета Skyeng в формат iCalendar (ICS) для подключения в любое календарное приложение. Про состоит из двух частей:

1. **Chrome-расширение** собирает куки пользователя из браузера и передаёт их вместе с часовым поясом на сервер.

2. **Серверные скрипты** обрабатывают куки, запрашивают расписание через API Skyeng, конвертируют данные в ICS и сохраняют их для скачивания пользователем.

Ниже подробно описано, какие папки и файлы входят в проект и за что они отвечают.

Структура проекта
-----------------

```bash
skyeng_calendar_project/
├── README.md
├── extension/
│   ├── manifest.json
│   ├── background.js
│   ├── popup.js
│   ├── popup.html
└── server/
│   ├── fetch.php
│   ├── upload_cookies.php
│   ├── generate.php
│   ├── update_all_ics.php   ← CLI-скрипт для периодической генерации всех .ics
│   ├── json/            ← Папка с результатами fetch.php
│   ├── timezone/        ← Папка с часовыми поясами пользователей
│   └── ics/             ← Папка для готовых .ics файлов

```

Описание папок и файлов
-----------------------

Корень проекта
--------------

* **README.md** Основная документация проекта: описание назначения, инструкции по установке, настройке и использованию.

Папка extension/
----------------

Хранит исходники Chrome-расширения, которое отвечает за авторизацию и передачу куки на сервер.

* **manifest.json**Описание расширения, списка разрешений и URL, к которым оно имеет доступ.

* **background.js**Основная логика расширения:

    1. Сбор куки из домена skyeng.ru.

    2. Отправка куки и часового пояса на сервер (upload\_cookies.php).

    3. Запрос расписания (fetch.php).

    4. Генерация ICS-файла (generate.php/{teacherId}.ics) и формирование ссылки на него.

* **popup.js**, **popup.html** Интерфейс расширения: кнопка запуска обновления и отображения ссылки на .ics файл.

Папка server/
-------------

Содержит PHP-скрипты и служебные папки для обработки запросов от расширения и генерации календарей.

* **fetch.php** Принимает POST-запрос с teacher\_id, использует переданные куки для аутентификации в закрытом API Skyeng и сохраняет расписание в JSON в папку server/json/{teacherId}\_events.json.

* **upload\_cookies.php** Принимает POST-запрос с куки пользователя и часовым поясом, сохраняет их для последующего использования в fetch.php и generate.php, возвращает teacher\_id в формате JSON.

* **generate.php** Конвертирует JSON-расписание и информацию о часовом поясе в файл iCalendar и сохраняет его как server/ics/{teacherId}.ics. Поддерживает как веб-запросы (через PATH\_INFO), так и CLI-вызов (при передаче teacherId в $argv).

* **update\_all\_ics.php** Скрипт для запуска из cron: находит все пары файлов cookies/{teacherId}\_cookies.txt и timezone/{teacherId}\_timezone.txt, вызывает server/generate.php для каждой пары и логирует результат.

* **json/** Директория для хранения промежуточных JSON-файлов с данными расписания.

* **timezone/** Здесь лежат файлы {teacherId}\_timezone.txt, содержащие название часового пояса пользователя (пример: Europe/Moscow).

* **ics/** Готовые .ics файлы, доступные по URL <https://vovanradio.online/ics/{teacherId}.ics>. Nginx отдаёт их напрямую из этой папки.

Как всё работает вместе
-----------------------

1. Пользователь кликает в расширении «Обновить расписание».

2. background.js:

    * собирает куки Skyeng,

    * отправляет их в upload\_cookies.php,

    * вызывает fetch.php для получения и сохранения JSON,

    * затем вызывает generate.php/{teacherId}.ics для создания iCalendar-файла и получает ссылку на скачивание.

3. .ics файл сохраняется в server/ics/ и сразу становится доступен по домену.

4. При помощи update\_all\_ics.php и cron-задачи проект может автоматически обновлять все ICS-файлы дважды в сутки.
